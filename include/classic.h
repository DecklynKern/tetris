#include "main.h"

static const int nes_level_colours[130][4] = {
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x30, 0x16, 0x12},
    {0x0F, 0x30, 0x27, 0x16},
    {0x0F, 0x30, 0x21, 0x12},
    {0x0F, 0x30, 0x29, 0x1A},
    {0x0F, 0x30, 0x24, 0x14},
    {0x0F, 0x30, 0x2A, 0x12},
    {0x0F, 0x30, 0x2B, 0x15},
    {0x0F, 0x30, 0x22, 0x2B},
    {0x0F, 0x30, 0x00, 0x16},
    {0x0F, 0x30, 0x05, 0x13},
    {0x0F, 0x25, 0x29, 0x27},
    {0x0F, 0x0B, 0x14, 0x30}
};

static const Uint32 nes_colour_palette[64] = {
    RGB(124, 124, 124),
    RGB(  0,   0, 252),
    RGB(  0,   0, 188),
    RGB( 68,  40, 188),
    RGB(148,   0, 132),
    RGB(168,   0,  32),
    RGB(168,  16,   0),
    RGB(136,  20,   0),
    RGB( 80,  48,   0),
    RGB(  0, 120,   0),
    RGB(  0, 104,   0),
    RGB(  0,  88,   0),
    RGB(  0,  64,  88),
    RGB(  0,   0,   0),
    RGB(  0,   0,   0),
    RGB(  0,   0,   0),
    RGB(188, 188, 188),
    RGB(  0, 120, 248),
    RGB(  0,  88, 248),
    RGB(104,  68, 252),
    RGB(216,   0, 204),
    RGB(228,   0,  88),
    RGB(248,  56,   0),
    RGB(228,  92,  16),
    RGB(172, 124,   0),
    RGB(  0, 184,   0),
    RGB(  0, 168,   0),
    RGB(  0, 168,  68),
    RGB(  0, 136, 136),
    RGB(  0,   0,   0),
    RGB(  0,   0,   0),
    RGB(  0,   0,   0),
    RGB(248, 248, 248),
    RGB( 60, 188, 252),
    RGB(104, 136, 252),
    RGB(152, 120, 248),
    RGB(248, 120, 248),
    RGB(248,  88, 152),
    RGB(248, 120,  88),
    RGB(252, 160,  68),
    RGB(248, 184,   0),
    RGB(184, 248,  24),
    RGB( 88, 216,  84),
    RGB( 88, 248, 152),
    RGB(  0, 232, 216),
    RGB(120, 120, 120),
    RGB(  0,   0,   0),
    RGB(  0,   0,   0),
    RGB(252, 252, 252),
    RGB(164, 228, 252),
    RGB(184, 184, 248),
    RGB(216, 184, 248),
    RGB(248, 184, 248),
    RGB(248, 164, 192),
    RGB(240, 208, 176),
    RGB(252, 224, 168),
    RGB(248, 216, 120),
    RGB(216, 248, 120),
    RGB(184, 248, 184),
    RGB(184, 248, 216),
    RGB(  0, 252, 252),
    RGB(248, 216, 248),
    RGB(  0,   0,   0),
    RGB(  0,   0,   0)
};

static Uint32 piece_colours[9] = {
    RGB(  0,   0,   0),
    RGB(128, 128, 128),
    RGB(128, 128, 128),
    RGB(128, 128, 128),
    RGB(128, 128, 128),
    RGB(128, 128, 128),
    RGB(128, 128, 128),
    RGB(128, 128, 128),
    RGB(200, 200, 200)
};

static const Point nrs_right_handed_minos[7][4][PIECE_MINO_COUNT] = {
    {   // O
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}},
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}},
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}},
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}}
    }, { // S
        {{ 0,  0}, { 1,  0}, {-1,  1}, { 0,  1}},
        {{ 0, -1}, { 0,  0}, { 1,  0}, { 1,  1}},
        {{ 0,  0}, { 1,  0}, {-1,  1}, { 0,  1}},
        {{ 0, -1}, { 0,  0}, { 1,  0}, { 1,  1}}
    }, { // Z
        {{-1,  0}, { 0,  0}, { 0,  1}, { 1,  1}},
        {{ 1, -1}, { 0,  0}, { 1,  0}, { 0,  1}},
        {{-1,  0}, { 0,  0}, { 0,  1}, { 1,  1}},
        {{ 1, -1}, { 0,  0}, { 1,  0}, { 0,  1}}
    }, { // L
        {{-1,  0}, { 0,  0}, { 1,  0}, {-1,  1}},
        {{ 0, -1}, { 0,  0}, { 0,  1}, { 1,  1}},
        {{ 1,  0}, {-1,  1}, { 0,  1}, { 1,  1}},
        {{-1, -1}, { 0, -1}, { 0,  0}, { 0,  1}}
    }, { // J
        {{-1,  0}, { 0,  0}, { 1,  0}, { 1,  1}},
        {{ 0, -1}, { 1, -1}, { 0,  0}, { 0,  1}},
        {{-1,  0}, {-1,  1}, { 0,  1}, { 1,  1}},
        {{ 0, -1}, { 0,  0}, {-1,  1}, { 0,  1}}
    }, { // T
        {{-1,  0}, { 0,  0}, { 1,  0}, { 0,  1}},
        {{ 0, -1}, { 0,  0}, { 1,  0}, { 0,  1}},
        {{ 0,  0}, {-1,  1}, { 0,  1}, { 1,  1}},
        {{ 0, -1}, {-1,  0}, { 0,  0}, { 0,  1}}
    }, { // I
        {{-1,  1}, { 0,  1}, { 1,  1}, { 2,  1}},
        {{ 1, -1}, { 1,  0}, { 1,  1}, { 1,  2}},
        {{-1,  1}, { 0,  1}, { 1,  1}, { 2,  1}},
        {{ 1, -1}, { 1,  0}, { 1,  1}, { 1,  2}}
    }
};

static const Point nrs_left_handed_minos[7][4][PIECE_MINO_COUNT] = {
    {   // O
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}},
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}},
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}},
        {{ 0,  0}, { 1,  0}, { 0,  1}, { 1,  1}}
    }, { // S
        {{ 0,  0}, { 1,  0}, {-1,  1}, { 0,  1}},
        {{-1, -1}, {-1,  0}, { 0,  0}, { 0,  1}},
        {{ 0,  0}, { 1,  0}, {-1,  1}, { 0,  1}},
        {{-1, -1}, {-1,  0}, { 0,  0}, { 0,  1}}
    }, { // Z
        {{-1,  0}, { 0,  0}, { 0,  1}, { 1,  1}},
        {{ 0, -1}, {-1,  0}, { 0,  0}, {-1,  1}},
        {{-1,  0}, { 0,  0}, { 0,  1}, { 1,  1}},
        {{ 0, -1}, {-1,  0}, { 0,  0}, {-1,  1}}
    }, { // L
        {{-1,  0}, { 0,  0}, { 1,  0}, {-1,  1}},
        {{ 0, -1}, { 0,  0}, { 0,  1}, { 1,  1}},
        {{ 1,  0}, {-1,  1}, { 0,  1}, { 1,  1}},
        {{-1, -1}, { 0, -1}, { 0,  0}, { 0,  1}}
    }, { // J
        {{-1,  0}, { 0,  0}, { 1,  0}, { 1,  1}},
        {{ 0, -1}, { 1, -1}, { 0,  0}, { 0,  1}},
        {{-1,  0}, {-1,  1}, { 0,  1}, { 1,  1}},
        {{ 0, -1}, { 0,  0}, {-1,  1}, { 0,  1}}
    }, { // T
        {{-1,  0}, { 0,  0}, { 1,  0}, { 0,  1}},
        {{ 0, -1}, { 0,  0}, { 1,  0}, { 0,  1}},
        {{ 0,  0}, {-1,  1}, { 0,  1}, { 1,  1}},
        {{ 0, -1}, {-1,  0}, { 0,  0}, { 0,  1}}
    }, { // I
        {{-1,  0}, { 0,  0}, { 1,  0}, { 2,  0}},
        {{ 1, -1}, { 1,  0}, { 1,  1}, { 1,  2}},
        {{-1,  0}, { 0,  0}, { 1,  0}, { 2,  0}},
        {{ 1, -1}, { 1,  0}, { 1,  1}, { 1,  2}}
    }
};

#define NUM_LEVELS 30
static const int gravity_factor_table[NUM_LEVELS] = {
    48,
    43,
    38,
    33,
    28,
    23,
    18,
    13,
    8,
    6,
    5,
    5,
    5,
    4,
    4,
    4,
    3,
    3,
    3,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    1
};

static Uint8 nes_to_tetrism_minotype[7] = {T, J, Z, O, S, L, I};
static Uint8 nes_orientation_id_table[7] = {2, 7, 8, 10, 11, 14, 18};

static void update_lfsr(void);
static MinoType new_piece(void);
static void update_colours(void);